# Take a newly installimage'd host and turn it into a fully upgraded Debian
# system that we can use.
#
# All of this should probably be removed in favor of using a custom image:
# https://wiki.hetzner.de/index.php/Installimage/en .
#
# Further, targeting testing or unstable will probably only guarantee that
# hosts fall out of syn with one another, whereas using the current stable
# release would be much more consistent.

# $ ansible-console-2.7 -f 6 -u root \
#     --ssh-common-args='-o StrictHostKeyChecking=no' -i prod -l gauss.jhpb.org
# Welcome to the ansible console.
# Type help or ? to list commands.
#
# root@all (1)[f:6]$ copy src=../autosetup dest=autosetup
# gauss.jhpb.org | CHANGED => {
#     "changed": true,
#     "checksum": "05587f23f273a8546d0ba36ec246417d2f3c0aca",
#     "dest": "./autosetup",
#     "gid": 0,
#     "group": "root",
#     "md5sum": "b212769622a487a55aba34acc4573738",
#     "mode": "0644",
#     "owner": "root",
#     "size": 619,
#     "src": "/root/.ansible/tmp/ansible-tmp-1549690693.31-52927625600297/source",
#     "state": "file",
#     "uid": 0
# }
# root@all (1)[f:6]$ shell /root/.oldroot/nfs/install/installimage -n "{{ inventory_hostname_short }}" -a -c autosetup
# root@all (1)[f:6]$ shell reboot
---
- hosts: all
  gather_facts: False
  remote_user: root
  # Note that this will not work in check mode, -C
  pre_tasks:
    - name: Install python for Ansible
      raw: bash -c "test -e /usr/bin/python || (apt -qqy update && apt install -qqy python-minimal)"
      register: output
      changed_when: output.stdout != ""
    - name: Gathering Facts
      setup:

- name: Prepare system for future use
  hosts: all
  remote_user: root

  vars:
    user_name: jasonp
    user_gecos: Jason Parker-Burlingham
    # TODO: make unique passwords and store on the ansible system.
    user_pass: $6$YDzKgb06ufenTu8$2wA9ZIG54RIpSy0jGydpQf3x2CSKpBmNUpAoY6AVpBSmZFk/OyDm82T4W3/6NmFzMvQdGGA/H.EHjCtqNDLeC.

  handlers:
  - name: restart sshd
    service:
      name: sshd
      state: restarted
  - name: reboot system
    reboot:

  tasks:
    - name: Set timezone
      timezone:
        name: US/Eastern
      notify:
        - reboot system

    # needs to also update /etc/hosts
    # see https://gist.github.com/rothgar/8793800
    - name: Set hostname
      hostname:
        name: "{{ inventory_hostname_short }}"
      notify:
        - reboot system

    - name: Generate /etc/hosts file
      template:
        src=hosts.j2
        dest=/etc/hosts

    # TODO: create role accounts.
    - name: Create user account with sudoers
      user: >
        name={{ user_name }}
        comment={{ user_gecos }}
        password={{ user_pass }}
        shell=/bin/bash
        groups=sudo
        append=yes
        state=present

    - name: Add SSH keys
      authorized_key:
        user: "{{ user_name }}"
        key: "{{ lookup('file', 'certs/id_rsa.pub') }}"
        state: present

    - name: Install sudo
      apt:
        name: sudo

    - name: Allow root SSH access
      lineinfile:
        dest: /etc/ssh/sshd_config
        regexp: "^PermitRootLogin"
        line: "PermitRootLogin yes"
        state: present
      notify:
        - restart sshd

    # apt_repository updates the APT cache for us, no need to do it later.
    - name: Target testing distribution
      apt_repository:
        repo: '{{ item }}'
      with_items:
        - deb http://mirror.hetzner.de/debian/packages testing main contrib non-free
        - deb http://ftp.de.debian.org/debian/ testing main non-free contrib
        - deb-src http://ftp.de.debian.org/debian/ testing main contrib

    - name: Upgrade to testing
      apt:
        upgrade: dist
      notify:
        - reboot system
