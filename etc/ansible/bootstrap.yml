# Take a newly installimage'd host and turn it into a fully upgraded Debian
# system that we can use.
#
# All of this should probably be removed in favor of using a custom image:
# https://wiki.hetzner.de/index.php/Installimage/en .
#
# Further, targeting testing or unstable will probably only guarantee that
# hosts fall out of syn with one another, whereas using the current stable
# release would be much more consistent.
---
- name: Boostrap Ansible by installing Python
  hosts: all
  remote_user: root
  gather_facts: False
  pre_tasks:
    - name: Install Python
      raw: test -e /usr/bin/python || (apt-get -y update && apt-get -y install python)
      register: test
      changed_when: test.stdout
    - setup:
      name: Run setup phase to gather facts

- name: Prepare system for future use
  hosts: all
  remote_user: root

  vars:
    user_name: jasonp
    user_gecos: Jason Parker-Burlingham
    # TODO: make unique passwords and store on the ansible system.
    user_pass: $6$XCfa2znJu6C$VHSq/l6FBXVydvvA7TQj1ZFgcO1yq0saIsrF2CkowbonISpeI5oIvPuENVVmEKfB6xXzZWdAqmOwMJZlYQXha1

  tasks:
    - name: Set hostname
      hostname:
        name: "{{ inventory_hostname_short }}"
      notify:
        - reboot system

    # TODO: create role accounts.
    - name: Create user account with sudoers
      user: >
        name={{ user_name }}
        comment={{ user_gecos }}
        password={{ user_pass }}
        shell=/bin/bash
        groups=sudo
        append=yes
        state=present

    - name: Add SSH keys
      authorized_key:
        user: "{{ user_name }}"
        key: "{{ lookup('file', 'certs/id_rsa.pub') }}"
        state: present

    - name: Remove root SSH access
      lineinfile: 
        dest: /etc/ssh/sshd_config
        regexp: "^PermitRootLogin"
        line: "PermitRootLogin no"
        state: present
      notify:
        - restart sshd

    # apt_repository updates the APT cache for us, no need to do it later.
    - name: Target testing distribution
      apt_repository:
        repo: '{{ item }}'
      with_items:
        - deb http://mirror.hetzner.de/debian/packages testing main contrib non-free
        - deb http://ftp.de.debian.org/debian/ testing main non-free contrib
        - deb-src http://ftp.de.debian.org/debian/ testing main contrib

    - name: Upgrade to testing
      apt:
        upgrade: dist
      notify:
        - reboot system

  handlers:
    - name: restart sshd
      service: name=sshd state=restarted
    - name: reboot system
      reboot:
